from math import pow
from unicodedata import name
import os

class LFSR:
    def __init__(self, tap, state):
        self._tap = tap
        self._state = state

    def getbit(self):
        f = sum([self._state[i] for i in self._tap]) & 1
        x = self._state[0]
        self._state = self._state[1:] + [f]
        return x , self._state

class triLFSR:
    def __init__(self, lfsr1, lfsr2, lfsr3):
        self.lfsr1 = lfsr1
        self.lfsr2 = lfsr2
        self.lfsr3 = lfsr3

    def getbit(self):
        x1 = self.lfsr1.getbit()
        print("x1 : ",x1)
        x2 = self.lfsr2.getbit()
        print("x2 : ",x2)
        x3 = self.lfsr3.getbit()
        print("x3 : ",x3)
        return x2 if x1 else x3

output = [1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1]

#75 bits key
#print(([random.randrange(2) for _ in range(23)]))
#Crack second LFSR ( 枚舉lfsr state 狀態，一個lfsr 要產生 200 次的 output，跟一堆output[:200] 比對，75%一樣，表示 state 中了

def enum_state3():
    for i in range(int(pow(2,25))):
        print(i)
        temp = format(i, "025b")
        lfsr_state = list(map(int, list(temp)))
        lfsr_200run(lfsr_state)


#一個lfsr 要產生 200 次的 output
def lfsr_200run(lfsr_state):
    list = []
    y = lfsr_state
    print(y)
    for i in range(200):
        lfsr3 = LFSR([0, 17, 19, 24], y)
        a = lfsr2.getbit()[0]
        b = lfsr2.getbit()[1]
        y = b        
        list.append(a)
    cor(list , output[232:432:1] ,lfsr_state)
    

#跟一堆output[:200] 比對
def cor(lista , listb ,lfsr_state):
    count = 0
    for i in range(200):
        if lista[i] == listb[i]:
            count += 1

    if count/200 >= 0.7 :
        print("Success")
        print(lfsr_state)
        print(lista)
        print(count/200)
        os._exit(0)
        
    else : 
        print(count/200)
        print("Fail")
        print(count)



#75%一樣，表示 state 中了
#cor(list , output[232:432:1])

if __name__ == '__main__':
    enum_state3()
# [HW] Node

1.先觀察了題目，從題目 check_point 函數可以推測這題是在考橢圓曲線，而這題的橢圓曲線是

$y^2 = x^3 -3x + 2$

```python
def check_point(P):
    if P == O:
        return True
    else:
        return (P.y**2 - (P.x**3 + a*P.x + b)) % p == 0 and 0 <= P.x < p and 0 <= P.y < p
```

2.這邊搜集了現有的資訊 ，並整理chal.py及output.txt的參數資訊如下

```python
#p is a prime
p = 143934749405770267808039109533241671783161568136679499142376907171125336784176335731782823029409453622696871327278373730914810500964540833790836471525295291332255885782612535793955727295077649715977839675098393245636668277194569964284391085500147264756136769461365057766454689540925417898489465044267493955801
#a and b are 
a = -3
b = 2
#G is a input point
Gx,Gy =  101806057140780850544714530443644783825785167075147195900696966628348944447492085252540090679241301721340985975519224144331425477628386574016040358648752353263802400527250163297781189749285392087154377684890287451078937692380556192126971669069015673662635561425735593795743852141232711066181542250670387203333, 21070877061047140448223994337863615306499412743288524847405886929295212764999318872250771845966630538832460153205159221566590942573559588219757767072634072564645999959084653451405037079311490089767010764955418929624276491280034578150363584012913337588035080509421139229710578342261017441353044437092977119013
#F is a output point
Fx,Fy = 98015495932907076864096258407988962007376328849899810250322002325625359735922937686533359455570369291999900476297694445557845368802830788062976760815467239661283157094425185337540578842851843497177780602415322706226426265515846633379203744588829488176045794602858847864402137150751961826536524265308139934971 , 87166136054299272658534592982430361675520319206099499992529237663935246617561944716447831162561604277568397630920048376392806047558420891922813475124718967889074322061747341780368922425396061468851460185861964432392408561769588468524187868171386564578362923777824279396698093857550091931091983893092436864205

```

3.利用 sagemath 的 ****Elliptic curves**** 去定義這個橢圓曲線，將其程式碼放到 sage 會發現，這是一個 Singular Curve。驗算 ( 4a^3 + 27b^2 = 0 ) 過後也證實了這是一個 Singular Curve，

```python
E = EllipticCurve([0,0,0,-3,2])
```

![截圖 2022-10-14 上午10.55.29.png](%5BHW%5D%20Node%20565d78d46b224c0299c92fde1240f7c1/%25E6%2588%25AA%25E5%259C%2596_2022-10-14_%25E4%25B8%258A%25E5%258D%258810.55.29.png)

![截圖 2022-10-14 上午10.58.34.png](%5BHW%5D%20Node%20565d78d46b224c0299c92fde1240f7c1/%25E6%2588%25AA%25E5%259C%2596_2022-10-14_%25E4%25B8%258A%25E5%258D%258810.58.34.png)

5.接下來我們知道老師上課有教，若橢圓曲線是 Singular Curve的話，There are two types of singular point 

Node : $y^2 = (x-α)^2(x-β)$

Cusp : $y^2 = x^3$

這邊可以很明顯知道，題目的曲線是 Node 的 Form，從做圖出來很明顯可以看到其有三個根 

x = 1 , 1 ,-2 ( 1 是重根 ），因此我們可以將原曲線分解為 Node 的 From

$y^2 = (x-1)^2(x+2)$   ，得到 $α = 1,β = -2$ 

![截圖 2022-10-14 上午10.56.47.png](%5BHW%5D%20Node%20565d78d46b224c0299c92fde1240f7c1/%25E6%2588%25AA%25E5%259C%2596_2022-10-14_%25E4%25B8%258A%25E5%258D%258810.56.47.png)

6.然後 Node 解法參考了課程講義 Crypto_0930.ppt - 41 頁，需要先在橢圓曲線的 Field 下，定義一個函數 phi，然後利用 hormomorphism 的 Property 去化簡函數，最後去解 Discrete Log 。

![截圖 2022-10-16 下午3.02.06.png](%5BHW%5D%20Node%20565d78d46b224c0299c92fde1240f7c1/%25E6%2588%25AA%25E5%259C%2596_2022-10-16_%25E4%25B8%258B%25E5%258D%25883.02.06.png)

7.有了這個解法後，就按照步驟去實作

a.直接根據講義已經證明過的結果去實作函數 phi，

```python
def phi(x,y):
    return  ( y + (a-b)* * (0.5) * (x-a) ) * inverse(( y - (a-b)* * (0.5) * (x-a) ) ,p)
```

b.利用 Homomorphism 的性質去推導函數，發現可以變成 discrete log problem on (𝔽p, ×)，但前提是 p 要是 smooth prime ，因此也用 sagemath 的 factor 去驗算，證實了，這是一個可以解的 discrete log problem。

$F = flag*G \ \ (\ mod\ p\ )$

$⇒ φ(F) ≡ φ(flag*G )\ \ (\ mod\ p\ )$

$⇒ φ(F) ≡  φ(G)^{flag} \ \ (\ mod\ p\ )$

$⇒ φ(G)^{flag} ≡ φ(F) \ \ (\ mod\ p\ )$

![截圖 2022-10-14 上午11.00.24.png](%5BHW%5D%20Node%20565d78d46b224c0299c92fde1240f7c1/%25E6%2588%25AA%25E5%259C%2596_2022-10-14_%25E4%25B8%258A%25E5%258D%258811.00.24.png)

1. 於是我有了以下的實作過程，但會發現問題，discrete_log 解出來的 flag 會是錯的。

```python
#In sgae
Gx, Gy = (101806057140780850544714530443644783825785167075147195900696966628348944447492085252540090679241301721340985975519224144331425477628386574016040358648752353263802400527250163297781189749285392087154377684890287451078937692380556192126971669069015673662635561425735593795743852141232711066181542250670387203333, 21070877061047140448223994337863615306499412743288524847405886929295212764999318872250771845966630538832460153205159221566590942573559588219757767072634072564645999959084653451405037079311490089767010764955418929624276491280034578150363584012913337588035080509421139229710578342261017441353044437092977119013)
Fx, Fy = (98015495932907076864096258407988962007376328849899810250322002325625359735922937686533359455570369291999900476297694445557845368802830788062976760815467239661283157094425185337540578842851843497177780602415322706226426265515846633379203744588829488176045794602858847864402137150751961826536524265308139934971 , 87166136054299272658534592982430361675520319206099499992529237663935246617561944716447831162561604277568397630920048376392806047558420891922813475124718967889074322061747341780368922425396061468851460185861964432392408561769588468524187868171386564578362923777824279396698093857550091931091983893092436864205)
p = 143934749405770267808039109533241671783161568136679499142376907171125336784176335731782823029409453622696871327278373730914810500964540833790836471525295291332255885782612535793955727295077649715977839675098393245636668277194569964284391085500147264756136769461365057766454689540925417898489465044267493955801

def phi(x,y):
    return  ( y + (a-b)* * (0.5) * (x-a) ) * inverse(( y - (a-b)* * (0.5) * (x-a) ) ,p)

a = phi( Gx , Gy )
b = phi( Fx , Fy )
discrete_log(b,a)
```

```python
#In python
from Crypto.Util.number import long_to_bytes
f = 2676073546977586965708398411271300382150616782779323939389114774325018659340980262484099358301651090323175215985064390229527492479938197361439869686885710900330671245571434966831486730806281974603946541751744391600045505443675351815308499587560257765088996542502145770357682162979637041147
print(long_to_bytes(f))
```

9.研究了很久之後，想到這邊是在橢圓曲線的 Field (𝔽p, ×)之下，因此，每個運算都會要 Mod p ，將 Mod p 再加入 phi 函數的運算中。 

```python
#In sage
Gx, Gy = (101806057140780850544714530443644783825785167075147195900696966628348944447492085252540090679241301721340985975519224144331425477628386574016040358648752353263802400527250163297781189749285392087154377684890287451078937692380556192126971669069015673662635561425735593795743852141232711066181542250670387203333, 21070877061047140448223994337863615306499412743288524847405886929295212764999318872250771845966630538832460153205159221566590942573559588219757767072634072564645999959084653451405037079311490089767010764955418929624276491280034578150363584012913337588035080509421139229710578342261017441353044437092977119013)
Fx, Fy = (98015495932907076864096258407988962007376328849899810250322002325625359735922937686533359455570369291999900476297694445557845368802830788062976760815467239661283157094425185337540578842851843497177780602415322706226426265515846633379203744588829488176045794602858847864402137150751961826536524265308139934971 , 87166136054299272658534592982430361675520319206099499992529237663935246617561944716447831162561604277568397630920048376392806047558420891922813475124718967889074322061747341780368922425396061468851460185861964432392408561769588468524187868171386564578362923777824279396698093857550091931091983893092436864205)
p = 143934749405770267808039109533241671783161568136679499142376907171125336784176335731782823029409453622696871327278373730914810500964540833790836471525295291332255885782612535793955727295077649715977839675098393245636668277194569964284391085500147264756136769461365057766454689540925417898489465044267493955801

def phi(x,y):
    return  Mod( y + sqrt(Mod(3,p)) * ( x - 1) ,p) * pow(Mod(y - sqrt(Mod(3,p)) * ( x - 1) ,p) ,-1 ,p )

a = phi( Gx , Gy )
b = phi( Fx , Fy )
discrete_log(b,a)
```

```python
#In python
from Crypto.Util.number import long_to_bytes
f = 2676073546977586965708398411271300382150616782779323939389114774325018659340980262484099358301651090323175215985064390229527492479938197361439869686885710900330671245571434966831486730806281974603946541751744391600045505443675351815308499587560257765088996542502145770357682162979637041147
print(long_to_bytes(f))
```

10.最後得到成功得到 FLAG{I_h3arD_th47_ECDlp_1s_h4rDEr_THaN_dlp}

Note. 參考資料

(1). [https://wiki.sagemath.org/quickref?action=AttachFile&do=get&target=quickref-zh.pdf](https://wiki.sagemath.org/quickref?action=AttachFile&do=get&target=quickref-zh.pdf)

(2). [https://crypto.stackexchange.com/questions/61302/how-to-solve-this-ecdlp](https://crypto.stackexchange.com/questions/61302/how-to-solve-this-ecdlp)

(3). [https://ithelp.ithome.com.tw/articles/10251031](https://ithelp.ithome.com.tw/articles/10251031)

(4). [https://drive.google.com/file/d/1WPa9gs-m9X-jfBRsOM17tLPSTJy7RAYu/edit?rtpof=true&ddrp=1#](https://drive.google.com/file/d/1WPa9gs-m9X-jfBRsOM17tLPSTJy7RAYu/edit?rtpof=true&ddrp=1#)
# [LAB] dlog

1. 這個 Lab 是在教會我們怎麼解決 Discrete Log Problem ，當初一直沒辦法理解輸入的 1024 bits Prime ，為什麼會沒有辦法得到 flag，後來重新聽了幾遍老師上課在這邊教學說的內容，説取得這邊 Prime 的方法是隨便挑幾個小質數相乘，並且 +1 要是質數。

2.於是我簡單重新整理了一下上課內容，解決離散對數的方法主要常見的有兩個

1. Baby-step giant-step :  是 meet-in-the-middle algorithm ，一種找離散對數比較簡單的方法。
2. Pohlig–Hellman algorithm : 假設e遠小於p, 時間複雜度的離散對數會遠小於 Baby-step giant-step

3.而實際的離散對數，$a^x ≡ b\ (\ mod\ p\ )$，可以直接透過以下的方式去計算，是老師上課說的，

而我自己有實際測試了a 跟 b 有沒有先進行 Mod p 的計算，在放入 discrete_log，影響速度

差很多，因此，實際解決 discrete_log，還是先進行 Mod p 的運算比較好。 

a = Mod(a,p)

b = Mod(b,p)

g = discrets_log ( b , a )

print(g)

4.於是開始嘗試解開這題 Lab，以下是解題過程：

先挑了幾個小的質數，13, 11, 3, 2 直接隨機的一直乘，並設定了兩個條件 ( “bit length 是 1024”

及 “n+1 是 prime”)， 找到了一個 smooth 的 prime。

```python
from Crypto.Util.number import getPrime, isPrime
import sys

for i in range(50,100):
    for j in range(50,100):
        for k in range(50,100):
            for l in range(50,100):
                for m in range(50,100):
                    n = (13**m)*(11**l)*(7**k)*(3**j)*(2**i)
                    if n.bit_length() == 1024:
                        if isPrime(n+1) == True :
                            print(i,j,k,l,m)
                            p = n+1
                            print("prime is : ",p)
                            sys.exit()
```

prime is : 117772959179701562715237125734256534149881366862884800947959468053567368116736040544073920733804912954949257898256693512832499050256759040191363124026679190130696568027403492752900806985979913863709008802934114372341433654704281055382215192916550050585648205476402560894006108172621703708623915609825640185857

然後將我的找到的使用 pwntools 傳送給 server，並取得Server 的返回值 ct，$ct = b^{flag}\ (\ mod\ p\ )$。

```python
#In python
from pwn import *
r = remote('edu-ctf.zoolab.org',10103)
p=117772959179701562715237125734256534149881366862884800947959468053567368116736040544073920733804912954949257898256693512832499050256759040191363124026679190130696568027403492752900806985979913863709008802934114372341433654704281055382215192916550050585648205476402560894006108172621703708623915609825640185857
b=13
r.readuntil(b"give me a prime")
r.sendline(str(p).encode())
r.readuntil(b"give me a number")
r.sendline(str(b).encode())
r.readuntil(b'The hint about my secret:')
ct = int(r.readline().strip())
print("ct :",ct)
```

將 $ct = b^{flag}\ (\ mod\ p\ ) => b^{flag} = ct\ (\ mod\ p\ )$ 轉化為解 discrete_log 的形式，並直接使用 sagemath 的 discrete_log 去解。

```python
#In sage
sage: p=117772959179701562715237125734256534149881366862884800947959468053567368
....: 11673604054407392073380491295494925789825669351283249905025675904019136312
....: 40266791901306965680274034927529008069859799138637090088029341143723414336
....: 54704281055382215192916550050585648205476402560894006108172621703708623915
....: 609825640185857
sage: b=13
sage: c=252867565775180311090117490402925363162536513793071559663542790100289613
....: 81220379825292460430617690166701912440833346217856108878819097676373434301
....: 71326164372121244016913741192187461373587173627953575726885817810558670504
....: 15089326057595631539459825230900897000868208993094063295135333340571590945
....: 0279980899855
sage: c=Mod(c,p)
sage: b=Mod(b,p)
sage: discrete_log(c,b)
```

discrete_log(c,b) = 49364843843516391046524858268527194975796465451738728838358032889241583861681330662807083126607252818067636491719629828923003523425778874385826820465255733017693947267318309123405222467130018070710428462698733027356868961329055426078777156769424135489040628746598412043633030066223026374555525280263553939381

再將上面的discrete_log值，使用python 的函數直接轉為 bytes。

```python
#In python
from Crypto.Util.number import long_to_bytes
flag = 49364843843516391046524858268527194975796465451738728838358032889241583861681330662807083126607252818067636491719629828923003523425778874385826820465255733017693947267318309123405222467130018070710428462698733027356868961329055426078777156769424135489040628746598412043633030066223026374555525280263553939381
print("Flag : ",long_to_bytes(flag))
```

5.最後，成功取得 FLAG{D0_No7_SLiP!!!1t'5_SM0o7h_OwO}

Note. 參考資料

(1).[https://en.wikipedia.org/wiki/Discrete_logarithm](https://en.wikipedia.org/wiki/Discrete_logarithm)

(2).[https://doc.sagemath.org/html/en/reference/groups/sage/groups/generic.html](https://doc.sagemath.org/html/en/reference/groups/sage/groups/generic.html)
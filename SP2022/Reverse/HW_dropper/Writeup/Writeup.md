# [HW] Dropper

1. 從提示 Dropper 可以知道，他會在程式中偷偷下載某種惡意程式至電腦並執行，因此我的想法是從程式中找到那一段的惡意程式碼，可能就可以找到跟 flag 有關的線索。

1. 首先，打開 IDA Pro會發現主要有三個函數，start、sub_140010472、sub_1400104B0 ，而我發現反編譯出來的程式碼沒有很多，應該Trace 完 sub_140010472、sub_1400104B0 這兩個函數，就可以找到要分析的點。

![截圖 2022-11-19 上午12.08.05.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%258812.08.05.png)

1. 大致上看了一下這兩個函數後，發現 sub_1400104B0 一開始有一段警示 // positive sp value has been detected, the output may be wrong ! 而上網查了一下，這是反編譯失敗的意思，但原因不知道，推測 IDA Pro 反編譯出來的程式碼可能會有問題，Trace 這些程式碼可能會沒有什麼意義。

![截圖 2022-11-19 上午12.11.46.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%258812.11.46.png)

![截圖 2022-11-19 上午12.16.50.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%258812.16.50.png)

1. 於是我先用 x64dbg 執行一次程式，程式執行到 Entry Point 之後，發現 RIP、RAX、RDX、R9 都會執行後回到 Entry Point，沒有辦法進入到某個地方，或是找到跟 Flag 有關的線索，於是嘗試從其他方面尋找相關資訊。

![截圖 2022-11-19 上午12.29.36.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%258812.29.36.png)

1. 從符號中，發現這支程式會載入的 dll 檔案還滿多的，其中我先注意到 cryptsp.dll、cryptbase.dll、bcrypt.dll 這幾個 dll 檔看起來跟加密有關，先查了 cryptsp.dll 的資訊，發現 Cryptographis Service Provider API 確實是會提供加密服務的 API。

![截圖 2022-11-19 上午12.57.27.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%258812.57.27.png)

![截圖 2022-11-19 上午1.02.16.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25881.02.16.png)

1. 接下來去尋找這個 dll 檔案調用的函數位址，先從第一個開始找，位址在 5c20 的地方，往下去閱覽也可以發現它去 call 一些函數，我把它們記錄下來，並去研究他們的功能，發現會開啟 Windows 的註冊表，並做了一些事情，上網查了一下這些組合會是去遍歷 Windows 註冊表項目。另外還在，066E8 的位址，發現 qword ptr ss:[rsp+F8] 裡面有字串 "CS_2022”。

![截圖 2022-11-19 上午1.07.55.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25881.07.55.png)

![截圖 2022-11-19 上午1.10.27.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25881.10.27.png)

| 函數 | 功能 |
| --- | --- |
| RegOpenKeyEx | 打開指定的註冊表項。 |
| RegQueryInfoKey | 檢索有關指定註冊表項的信息。 |
| LocalAlloc | 從堆中分配指定數量的字節。 |
| RegEnumKeyEx | 枚舉指定的打開註冊表項的子項。每次調用該函數時，都會檢索有關一個子項的信息。 |
| atol | Convert a string to a long integer。 |
| RegQueryValueEx | 檢索與打開的註冊表項關聯的指定值名稱的類型和數據。 |
| RegCloseKey | 關閉指定註冊表項的句柄。 |
| LocalFree | 釋放指定的本地內存對象並使其句柄無效。 |
| Restore Last Win32Error | 當許多系統功能失敗時，它們會設置最後一個錯誤代碼。 |

![截圖 2022-11-19 上午1.57.54.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25881.57.54.png)

![截圖 2022-11-19 上午2.00.19.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25882.00.19.png)

1. 到這邊可以推測程式會去 Windows 註冊表做一些事情，並且可能會用到 “CS_2022” 這個字串，但我開啟 registry 之後，稍微翻閱了一下，沒有辦法看出什麼線索。

![截圖 2022-11-19 上午2.20.58.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258A%25E5%258D%25882.20.58.png)

1. 於是開始去尋找其他線索，在x64 中，記憶體映射裡面，找到 dropper.exe，裡面看到有兩個記憶體位址給出來的資訊是 “UPX0”、“UPX1”，看起來是跟 UPX 殼有關的資訊。於我去尋找是否有自動判斷程式殼的種類的程式，發現 Detect It Easy 有這個功能，下載來使用後，再把 dropper.exe 放進去使用，結果它是 UPX(3.96)[NRV,brute]，上網查了一下 3.96 是 UPX 殼的版本資訊。

![截圖 2022-11-19 下午12.31.53.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%258812.31.53.png)

![截圖 2022-11-19 下午12.39.32.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%258812.39.32.png)

1. 接下來我的想法是，將它脫殼的話，也許 IDA Pro 反編譯出來的程式碼會容易讀一點，於是上網下載 UPX Packeage，並直接執行”upx.exe -d dropper.exe”，成功後用 IDA pro 再開啟程式，結果竟然真的成功分析出之前沒有的 Functions。

![截圖 2022-11-19 下午12.55.55.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%258812.55.55.png)

![截圖 2022-11-19 下午12.55.14.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%258812.55.14.png)

1. 接下來找到 main 函數後，發現程式最下面有解析出看起來比較重要的程式碼，有”CS_2022” 的字串，推測這邊應該是最重要的部分，但這邊看不太懂這些函數的功能。

![截圖 2022-11-19 下午1.00.37.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25881.00.37.png)

1. 於是往回追會發現函數在上面都會用到，但沒辦法知道是什麼函數。

![截圖 2022-11-19 下午2.04.51.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.04.51.png)

![截圖 2022-11-19 下午2.04.58.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.04.58.png)

![截圖 2022-11-19 下午2.05.12.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.12.png)

![截圖 2022-11-19 下午2.05.18.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.18.png)

![截圖 2022-11-19 下午2.05.25.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.25.png)

![截圖 2022-11-19 下午2.05.31.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.31.png)

![截圖 2022-11-19 下午2.05.38.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.38.png)

![截圖 2022-11-19 下午2.05.44.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.44.png)

![截圖 2022-11-19 下午2.05.50.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.50.png)

![截圖 2022-11-19 下午2.05.57.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.05.57.png)

![截圖 2022-11-19 下午2.06.04.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.06.04.png)

1. 於是我將函數的 RVA 到 x64dbg 中去搜尋，發現他這邊可以從 RAX 找到函數的名稱，於是我到 MSDN 中搜尋，可以找到對應的函數及結構，然後至 IDA Pro 中修改函數名稱及結構，修改完後，程式最下面的地方，會變成可讀性比較高的程式，到這邊也知道為什麼程式會停住，因為程式會 sleep(2592000000i64) 的時間。

![截圖 2022-11-19 下午2.53.50.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.53.50.png)

![截圖 2022-11-19 下午2.45.59.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.45.59.png)

1. 接下來我到 x64dbg 中，將 sleep 這個函數 nop 掉，讓程式不要 sleep，然後單步執行，看會發生什麼事情。

![截圖 2022-11-19 下午2.59.17.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25882.59.17.png)

1. 結果程式執行到2DA9 的位置時，就跑出FLAG，於是得到 FLAG{H3r3_U_G0_iT_Is_UR_flAg}。解完之後，有想到不知道程式去 registry 做什麼事情，於是點開 registry 發現它在註冊表新增了一個項目是 “CS_2022”，並且把 FLAG 寫進去。

![截圖 2022-11-19 下午3.03.19.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-19_%25E4%25B8%258B%25E5%258D%25883.03.19.png)

![截圖 2022-11-17 下午3.29.02.png](%5BHW%5D%20Dropper%20a5d409efec7c48788b239b57e0195406/%25E6%2588%25AA%25E5%259C%2596_2022-11-17_%25E4%25B8%258B%25E5%258D%25883.29.02.png)

Note.

1.IDA Pro 反編譯失敗訊息 : [https://blog.csdn.net/xiangshangbashaonian/article/details/81950110](https://blog.csdn.net/xiangshangbashaonian/article/details/81950110)

2.cryptsp.dll 說明 : [https://www.file.net/process/cryptsp.dll.html](https://www.file.net/process/cryptsp.dll.html)

[3.Windows](http://3.Windows) **[注冊表](https://www.cnblogs.com/wzzkaifa/p/6950722.html) 說明** [https://www.cnblogs.com/wzzkaifa/p/6950722.html](https://www.cnblogs.com/wzzkaifa/p/6950722.html)

3.UPX 脫殼：[https://www.twblogs.net/a/5d3f8c96bd9eee517422a992](https://www.twblogs.net/a/5d3f8c96bd9eee517422a992)

4.加殼與脫殼原理詳解 : [https://www.cnblogs.com/cainiao-chuanqi/p/14763537.html](https://www.cnblogs.com/cainiao-chuanqi/p/14763537.html)